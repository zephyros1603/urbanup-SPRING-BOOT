<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <h1>WebSocket Chat Test</h1>
    
    <div>
        <h3>Connection Status: <span id="status">Disconnected</span></h3>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>
    
    <div>
        <h3>Send Message</h3>
        <input type="text" id="messageInput" placeholder="Type your message..." />
        <button onclick="sendMessage()">Send</button>
    </div>
    
    <div>
        <h3>Messages</h3>
        <div id="messages" style="border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px;"></div>
    </div>

    <script>
        let stompClient = null;
        const chatId = 9; // Chat ID from our test
        const token = "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOjQyLCJzdWIiOiJjaGF0dXNlcjFAdGVzdC5jb20iLCJpYXQiOjE3NTQ0OTU3NTEsImV4cCI6MTc1NDU4MjE1MX0.sAWRtc3zi4r1maaXVjSe77i1C64GKjcvkkDao2AFCdA";
        
        function connect() {
            const socket = new SockJS('http://localhost:8080/api/ws');
            stompClient = Stomp.over(socket);
            
            // Add JWT token to headers (try multiple methods for compatibility)
            const headers = {
                'Authorization': 'Bearer ' + token,
                'token': token  // Alternative for SockJS compatibility
            };
            
            stompClient.connect(headers, function (frame) {
                document.getElementById('status').innerHTML = 'Connected';
                console.log('Connected: ' + frame);
                addMessage('Successfully connected to WebSocket');
                
                // Subscribe to chat messages
                stompClient.subscribe('/topic/chat/' + chatId + '/messages', function (message) {
                    addMessage('Received: ' + message.body);
                });
                
                // Subscribe to typing indicators
                stompClient.subscribe('/topic/chat/' + chatId + '/typing', function (message) {
                    addMessage('Typing: ' + message.body);
                });
                
                // Subscribe to presence updates
                stompClient.subscribe('/topic/chat/' + chatId + '/presence', function (message) {
                    addMessage('Presence: ' + message.body);
                });
                
                // Subscribe to read receipts
                stompClient.subscribe('/topic/chat/' + chatId + '/read', function (message) {
                    addMessage('Read receipt: ' + message.body);
                });
                
            }, function(error) {
                document.getElementById('status').innerHTML = 'Connection Failed';
                console.log('Connection error: ' + error);
                addMessage('Connection error: ' + error);
            });
        }
        
        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            document.getElementById('status').innerHTML = 'Disconnected';
            console.log("Disconnected");
        }
        
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message && stompClient && stompClient.connected) {
                const payload = {
                    content: message,
                    messageType: 'TEXT'
                };
                
                stompClient.send('/app/chat/' + chatId + '/send', {}, JSON.stringify(payload));
                addMessage('Sent: ' + message);
                messageInput.value = '';
            } else {
                addMessage('Error: Not connected or empty message');
            }
        }
        
        function addMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.innerHTML = new Date().toLocaleTimeString() + ': ' + message;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Send message on Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
